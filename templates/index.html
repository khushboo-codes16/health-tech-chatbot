<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        },
                        secondary: {
                            700: '#026fff',
                            500: '#0c8aff',
                            300: '#3d9eff'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        /* Markdown styling */
        .markdown-content h1, .markdown-content h2, .markdown-content h3, 
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            color: white;
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: bold;
        }
        .markdown-content h1 { font-size: 1.8em; }
        .markdown-content h2 { font-size: 1.5em; }
        .markdown-content h3 { font-size: 1.3em; }
        .markdown-content ul, .markdown-content ol {
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
        .markdown-content li {
            margin-bottom: 0.5em;
        }
        .markdown-content code {
            background: rgba(255,255,255,0.1);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: monospace;
        }
        .markdown-content pre {
            background: rgba(0,0,0,0.3);
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        .markdown-content blockquote {
            border-left: 3px solid #4ade80;
            padding-left: 1em;
            margin-left: 0;
            color: #a0aec0;
        }
        .markdown-content a {
            color: #4ade80;
            text-decoration: underline;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-800 min-h-screen flex">
    <!-- Sidebar -->
    <div class="w-72 bg-gray-800 border-r border-gray-700 flex flex-col h-screen fixed">
        <div class="p-4 border-b border-gray-700">
            <h3 class="text-xl font-bold text-white text-center">Chat History</h3>
        </div>
        <div class="p-4 space-y-2">
            <button onclick="clearChat()" class="w-full bg-gradient-to-r from-primary-600 to-primary-500 text-white py-2 px-4 rounded-lg font-medium hover:from-primary-700 hover:to-primary-600 transition-all duration-200 flex items-center justify-center">
                <i class="fas fa-plus mr-2"></i> New Chat
            </button>
            <button onclick="deleteChatHistory()" class="w-full bg-gradient-to-r from-red-600 to-red-500 text-white py-2 px-4 rounded-lg font-medium hover:from-red-700 hover:to-red-600 transition-all duration-200 flex items-center justify-center">
                <i class="fas fa-trash-alt mr-2"></i> Clear History
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="chat-history"></div>
        <div class="p-4 border-t border-gray-700">
            <div class="flex items-center justify-between text-gray-400">
                <span>Logged in as: <span class="text-primary-400">{{ email }}</span></span>
                <button onclick="logout()" class="bg-gradient-to-r from-red-600 to-red-500 text-white py-1 px-3 rounded text-sm hover:from-red-700 hover:to-red-600 transition-all duration-200">
                    Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 ml-72 p-6 flex flex-col h-screen">
        <div class="flex-1 overflow-y-auto mb-4" id="chat-box">
            <!-- Welcome message -->
            <div class="max-w-3xl mx-auto mb-8 text-center">
                <h1 class="text-3xl font-bold text-white mb-2">Welcome to AI Chat</h1>
                <p class="text-gray-400">Ask me Health & Technology related questions and I'll do my best to help!</p>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="max-w-3xl mx-auto w-full">
            <div class="relative flex items-center">
                <input 
                    type="text" 
                    id="user-input" 
                    placeholder="Type your message here..." 
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg py-3 px-4 pr-12 text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent placeholder-gray-400"
                    oninput="toggleSendButton()"
                    onkeypress="if(event.key === 'Enter') sendMessage()"
                >
                <button 
                    id="send-button" 
                    onclick="sendMessage()" 
                    disabled
                    class="absolute right-2 bg-gradient-to-r from-primary-600 to-primary-500 text-white p-2 rounded-lg hover:from-primary-700 hover:to-primary-600 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-2 text-center">AI may produce inaccurate information. Consider verifying important facts.</p>
        </div>
    </div>

    <!-- Include Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Initialize with empty chat history
        let currentChatId = null;
        
        function toggleSendButton() {
            const userInput = document.getElementById('user-input').value.trim();
            document.getElementById('send-button').disabled = !userInput;
        }

        async function sendMessage() {
    const userInput = document.getElementById('user-input').value.trim();
    if (!userInput) return;
    
    const chatBox = document.getElementById('chat-box');
    
    // Add user message to chat
    chatBox.innerHTML += `
        <div class="max-w-3xl mx-auto mb-4 flex justify-end">
            <div class="bg-gradient-to-r from-primary-600 to-primary-500 text-white rounded-xl px-4 py-3 max-w-[80%]">
                ${userInput}
            </div>
        </div>
    `;
    
    // Clear input and disable send button
    document.getElementById('user-input').value = '';
    document.getElementById('send-button').disabled = true;
    
    // Show loading indicator
    const loadingId = 'loading-' + Date.now();
    chatBox.innerHTML += `
        <div class="max-w-3xl mx-auto mb-4 flex justify-start" id="${loadingId}">
            <div class="bg-gray-700 rounded-xl px-4 py-3 max-w-[80%] flex items-center">
                <div class="dot-flashing"></div>
            </div>
        </div>
    `;
    
    // Scroll to bottom
    chatBox.scrollTop = chatBox.scrollHeight;
    
    try {
        const response = await fetch('http://127.0.0.1:5000/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ question: userInput })  // Changed from prompt to question
        });

        const data = await response.json();
        
        // Remove loading indicator
        document.getElementById(loadingId).remove();
        
        if (response.ok) {
            // Parse Markdown and render as HTML
            const formattedResponse = marked.parse(data.data || "No response available.");
            currentChatId = data.chat_id;
            
            chatBox.innerHTML += `
                <div class="max-w-3xl mx-auto mb-4 flex justify-start">
                    <div class="bg-gray-700 rounded-xl px-4 py-3 max-w-[80%]">
                        <div class="markdown-content">${formattedResponse}</div>
                        <div class="flex justify-end mt-2 space-x-2">
                            <button onclick="rateChat('${data.chat_id}', 'like')" class="text-green-400 hover:text-green-300">
                                <i class="fas fa-thumbs-up"></i>
                            </button>
                            <button onclick="rateChat('${data.chat_id}', 'dislike')" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-thumbs-down"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            loadChatHistory(); // Reload chat history after sending a message
        } else {
            chatBox.innerHTML += `
                <div class="max-w-3xl mx-auto mb-4 flex justify-start">
                    <div class="bg-red-900/30 text-red-400 rounded-xl px-4 py-3 max-w-[80%]">
                        <strong>Error:</strong> ${data.error || "Something went wrong."}
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error("Error:", error);
        document.getElementById(loadingId).remove();
        chatBox.innerHTML += `
            <div class="max-w-3xl mx-auto mb-4 flex justify-start">
                <div class="bg-red-900/30 text-red-400 rounded-xl px-4 py-3 max-w-[80%]">
                    <strong>Error:</strong> Failed to get a response.
                </div>
            </div>
        `;
    }

    // Re-enable send button and scroll to bottom
    document.getElementById('send-button').disabled = false;
    chatBox.scrollTop = chatBox.scrollHeight;
}

        async function loadChatHistory() {
            try {
                const response = await fetch('/get_chat_history');
                const data = await response.json();
                
                if (response.ok) {
                    const historyContainer = document.getElementById("chat-history");
                    historyContainer.innerHTML = "";

                    if (data.chat_history.length === 0) {
                        historyContainer.innerHTML = `
                            <div class="text-center text-gray-500 p-4">
                                No chat history yet
                            </div>
                        `;
                        return;
                    }

                    data.chat_history.forEach((chat, index) => {
                        const chatItem = document.createElement("div");
                        chatItem.className = `p-3 rounded-lg mb-2 cursor-pointer transition-all ${currentChatId === chat._id ? 'bg-gray-700' : 'hover:bg-gray-700'}`;
                        chatItem.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="text-white truncate">${chat.question || "Chat ${index + 1}"}</div>
                                <button onclick="deleteChat('${chat._id}', event)" class="text-red-400 hover:text-red-300 ml-2">
                                    <i class="fas fa-trash-alt text-sm"></i>
                                </button>
                            </div>
                            <div class="text-xs text-gray-400 truncate mt-1">
                                ${new Date(chat.timestamp).toLocaleString()}
                            </div>
                        `;
                        chatItem.onclick = () => loadChat(chat);
                        historyContainer.appendChild(chatItem);
                    });
                } else {
                    console.error("Error fetching chat history:", data.error);
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        function loadChat(chat) {
            const chatBox = document.getElementById("chat-box");
            currentChatId = chat._id;
            
            chatBox.innerHTML = `
                <div class="max-w-3xl mx-auto mb-4 flex justify-end">
                    <div class="bg-gradient-to-r from-primary-600 to-primary-500 text-white rounded-xl px-4 py-3 max-w-[80%]">
                        ${chat.question}
                    </div>
                </div>
                <div class="max-w-3xl mx-auto mb-4 flex justify-start">
                    <div class="bg-gray-700 rounded-xl px-4 py-3 max-w-[80%]">
                        <div class="markdown-content">${marked.parse(chat.answer)}</div>
                        <div class="flex justify-end mt-2 space-x-2">
                            <button onclick="rateChat('${chat._id}', 'like')" class="text-green-400 hover:text-green-300">
                                <i class="fas fa-thumbs-up"></i>
                            </button>
                            <button onclick="rateChat('${chat._id}', 'dislike')" class="text-red-400 hover:text-red-300">
                                <i class="fas fa-thumbs-down"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Highlight the selected chat in history
            loadChatHistory();
        }

        async function deleteChat(chatId, event) {
            event.stopPropagation(); // Prevent the chat from being loaded when deleting
            
            if (!confirm("Are you sure you want to delete this chat?")) return;
        
            try {
                const response = await fetch(`/delete_chat/${chatId}`, { method: 'DELETE' });
                const data = await response.json();

                if (response.ok) {
                    if (currentChatId === chatId) {
                        clearChat();
                        currentChatId = null;
                    }
                    loadChatHistory(); // Reload chat history after deletion
                } else {
                    alert("Failed to delete chat: " + data.error);
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Error deleting chat.");
            }
        }

        async function deleteChatHistory() {
            if (!confirm("Are you sure you want to delete all chat history?")) return;
        
            try {
                const response = await fetch('/delete_chat_history', { method: 'DELETE' });
                const data = await response.json();

                if (response.ok) {
                    clearChat();
                    currentChatId = null;
                    loadChatHistory(); // Reload chat history after deletion
                } else {
                    alert("Failed to delete chat history: " + data.error);
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Error deleting chat history.");
            }
        }

        async function rateChat(chatId, action) {
            try {
                const response = await fetch(`/rate_chat/${chatId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action })
                });

                const data = await response.json();
                if (response.ok) {
                    // Visual feedback
                    const button = event.target.closest('button');
                    button.innerHTML = action === 'like' 
                        ? '<i class="fas fa-check text-green-400"></i>' 
                        : '<i class="fas fa-times text-red-400"></i>';
                    
                    setTimeout(() => {
                        button.innerHTML = action === 'like' 
                            ? '<i class="fas fa-thumbs-up"></i>' 
                            : '<i class="fas fa-thumbs-down"></i>';
                    }, 1000);
                } else {
                    console.log("Failed to rate chat: " + data.error);
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        function clearChat() {
            document.getElementById("chat-box").innerHTML = `
                <div class="max-w-3xl mx-auto mb-8 text-center">
                    <h1 class="text-3xl font-bold text-white mb-2">Welcome to AI Chat</h1>
                    <p class="text-gray-400">Ask me Health & Technology related questions and I'll do my best to help!</p>
                </div>
            `;
            currentChatId = null;
        }

        async function logout() {
            try {
                const response = await fetch('/logout', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    window.location.href = "/"; // Redirect to login page
                } else {
                    alert("Failed to logout: " + data.error);
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Error logging out.");
            }
        }

        // Load chat history when page loads
        window.onload = loadChatHistory;
        
        // Loading animation CSS
        const style = document.createElement('style');
        style.textContent = `
            .dot-flashing {
                position: relative;
                width: 10px;
                height: 10px;
                border-radius: 5px;
                background-color: #a0aec0;
                color: #a0aec0;
                animation: dotFlashing 1s infinite linear alternate;
                animation-delay: .5s;
                margin-right: 15px;
            }
            .dot-flashing::before, .dot-flashing::after {
                content: '';
                display: inline-block;
                position: absolute;
                top: 0;
            }
            .dot-flashing::before {
                left: -15px;
                width: 10px;
                height: 10px;
                border-radius: 5px;
                background-color: #a0aec0;
                color: #a0aec0;
                animation: dotFlashing 1s infinite alternate;
                animation-delay: 0s;
            }
            .dot-flashing::after {
                left: 15px;
                width: 10px;
                height: 10px;
                border-radius: 5px;
                background-color: #a0aec0;
                color: #a0aec0;
                animation: dotFlashing 1s infinite alternate;
                animation-delay: 1s;
            }
            @keyframes dotFlashing {
                0% { background-color: #a0aec0; }
                50%, 100% { background-color: #4a5568; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>